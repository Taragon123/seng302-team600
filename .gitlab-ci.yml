tag_checker:
  stage: build
  script:
    - python tag_checker.py $CI_COMMIT_TAG
  only:
    - tags


image: gradle:alpine
variables:
  SONAR_TOKEN: "0a1467036e853397c101cf62ed6658536721f7e4"
  SONAR_HOST_URL: "https://csse-s302g6.canterbury.ac.nz/sonarqube/"
  GIT_DEPTH: 0
sonarqube-check:
  stage: test
  script:
    - cd server
    - ./gradlew sonarqube -Dsonar.qualitygate.wait=true
    - cd ../client
    - npm install
    - npm run sonarqube
  allow_failure: true
  only:
    - development

junit:
  stage: test
  script:
    - cd server
    - ./gradlew test

dev-build:
  stage: deploy
  script:
    - fuser -k 9499/tcp 9500/tcp || true
    - cd client
    - npm install
    - npm run build
    - cd ../server
    - ./gradlew bootJar
    - cd ..
    - mkdir -p ../client-dev/
    - mkdir -p ../server-dev/
    - cp -r ./client/dist/ ../client-dev/
    - cp -r ./server/build/libs ../server-dev/
    - bash startTestApplication /tmp 2>> /dev/null >>/dev/null
  except:
    - tags
  only:
    - development

release-build:
 stage: deploy
 script:
    - fuser -k 8999/tcp 9000/tcp
    - cd client
    - npm install
    - npm run build-prod
    - cd ../server
    - ./gradlew bootJar
    - cd ..
    - mkdir -p ../client-prod/
    - mkdir -p ../server-prod/
    - cp -r ./client/dist/ ../client-prod/
    - cp -r ./server/build/libs ../server-prod/
    - bash startProdApplication /tmp 2>> /dev/null >>/dev/null
 artifacts:
    paths:
    - client/dist
    - server/out
 only:
    - tags
